worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    client_max_body_size 20m;

    # Используем DNS-резолвер Docker, чтобы имена сервисов
    # (security, uploader, storage) могли резолвиться динамически
    resolver 127.0.0.11 ipv6=off;

    upstream security {
        zone security 64k;
        server security:3000 resolve;
    }

    upstream uploader {
        zone uploader 64k;
        server uploader:3000 resolve;
    }

    upstream storage {
        zone storage 64k;
        server storage:9000 resolve;
    }

    server {
        listen 8080;
        server_name _;

        # Health-check самого gateway
        location = /status {
            add_header Content-Type application/json;
            return 200 '{"status":"OK"}';
        }

        # ===== Анонимные эндпоинты авторизации =====

        # POST /token -> security /v1/token
        location = /token {
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_pass http://security/v1/token;
        }

        # Опциональный alias /v1/token
        location = /v1/token {
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_pass http://security/v1/token;
        }

        # ===== Внутренняя проверка токена через auth_request =====

        # Внутренняя локация, которая дергает security /v1/token/validation
        location = /auth {
            internal;

            # validation использует только заголовок Authorization и метод GET
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";

            proxy_method GET;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;

            proxy_pass http://security/v1/token/validation;
        }

        # ===== Защищённый эндпоинт загрузки файла =====

        # POST /upload -> uploader /v1/upload (с проверкой токена)
        location = /upload {
            auth_request /auth;

            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_pass http://uploader/v1/upload;
        }

        # Опциональный alias /v1/upload
        location = /v1/upload {
            auth_request /auth;

            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_pass http://uploader/v1/upload;
        }

        # ===== Защищённый эндпоинт получения файла =====

        # GET /images/<filename> -> MinIO /data/<filename> (с проверкой токена)
        location /images/ {
            auth_request /auth;

            # MinIO bucket "data" доступен публично (policy download),
            # поэтому Authorization ему не нужен
            proxy_set_header Authorization "";

            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # /images/<file> снаружи -> /data/<file> для MinIO
            proxy_pass http://storage/data/;
        }
    }
}